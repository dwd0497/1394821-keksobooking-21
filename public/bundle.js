(()=>{"use strict";const e="100 комнат не для гостей",t="Не для гостей только 100 комнатные номера",o="Количество мест не может превышать количество комнат",r="Произошла ошибка соединения.",n="Запрос не успел выполниться за",s="мс",c="GET",a="POST",u="https://21.javascript.pages.academy/keksobooking/data",l="https://21.javascript.pages.academy/keksobooking",i={400:"Неверный запрос. Ошибка 400.",401:"Пользователь не авторизован. Ошибка 401.",404:"Информация не найдена. Ошибка 404.",500:"Ошибка сервера. Ошибка 500."},d=(e,t,o,a=c,u=null)=>{const l=new XMLHttpRequest;l.responseType="json",l.addEventListener("load",(()=>{200===l.status?t(l.response):o(i[l.status])})),l.addEventListener("error",(function(){o(r)})),l.addEventListener("timeout",(function(){o(`${n} ${l.timeout} ${s}`)})),l.timeout=1e4,l.open(a,e),l.send(u)},p=e=>{let t=null;return(...o)=>{t&&clearTimeout(t),t=setTimeout((()=>{e(...o)}),500)}};function m(e){return"Enter"===e.key}function f(e){return"Escape"===e.key}const y=(e,t,o,r=null)=>{const n=document.createDocumentFragment();let s=[];return r&&(e=e.slice(0,r)),e.forEach(((e,t)=>{const r=o(e,t);n.appendChild(r),s.push(r)})),t.appendChild(n),s},h=(e,t,o)=>{v(t),((e,t,o)=>{const r=document.createDocumentFragment();e.forEach(((e,t)=>{r.appendChild(o(e,t))})),t.appendChild(r)})(e,t,o)},v=e=>{for(;e.firstChild;)e.firstChild.remove()},g=["gif","jpg","jpeg","png"],_=(e,t,o)=>{e[o?"addEventListener":"removeEventListener"]("change",(()=>{const o=e.files[0],r=o.name.toLowerCase();if(g.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{"IMG"!==t.tagName?(e=>{const t=document.createElement("img");return t.style.width="44px",t.style.height="40px",e.appendChild(t),t})(t).src=e.result:t.src=e.result})),e.readAsDataURL(o)}}))},S={bungalow:0,flat:1e3,house:5e3,palace:1e4},q=document.querySelector("main"),L=document.querySelector(".ad-form"),E=L.querySelector("#address"),x=L.querySelector("#capacity"),k=L.querySelector("#room_number"),C=L.querySelector("#type"),w=L.querySelector("#price"),b=L.querySelector("#timein"),T=L.querySelector("#timeout"),$=document.querySelector(".map__filters"),V=document.querySelector(".ad-form__reset"),j=document.querySelector("#success").content.querySelector(".success"),D=document.querySelector("#error").content.querySelector(".error"),M=document.querySelector("#avatar"),N=document.querySelector(".ad-form-header__preview img"),F=document.querySelector("#images"),I=document.querySelector(".ad-form__photo"),X=(e,t)=>{var o,r;o=e,r=function(e){e.disabled=t},Array.prototype.forEach.call(o,r)};X(L.children,!0),X($.children,!0);const H=(r,n,s)=>{100===r&&0!==n?s.setCustomValidity(e):r<n&&0!==n?s.setCustomValidity(o):100!==r&&0===n?s.setCustomValidity(t):s.setCustomValidity(""),s.reportValidity()},R=()=>{const e=+x.value,t=+k.value;H(t,e,x)},W=()=>{const e=+x.value,t=+k.value;H(t,e,x)},Y=()=>{w.min=S[C.value],w.placeholder=S[C.value]},A=()=>{T.value=b.value},G=()=>{b.value=T.value},O=e=>{e.preventDefault();const t=+x.value,o=+k.value;H(o,t,x),x.checkValidity()&&k.checkValidity()&&((e,t,o)=>{d(l,e,t,a,o)})(U,z,new FormData(L))},B=e=>()=>{e.remove()},P=e=>t=>{f(t)&&(document.removeEventListener("keydown",P(e)),e.remove())},U=()=>{(()=>{const e=j.cloneNode(!0);L.appendChild(e),e.addEventListener("click",B(e)),document.addEventListener("keydown",P(e))})(),Ge(),L.reset()},z=e=>{(e=>{const t=D.cloneNode(!0),o=t.querySelector(".error__message"),r=t.querySelector(".error__button");o.textContent=e,q.appendChild(t),t.addEventListener("click",B(t)),r.addEventListener("click",(e=>()=>{e.remove()})(t)),document.addEventListener("keydown",P(t))})(e)},J=e=>{const t=e?"addEventListener":"removeEventListener";x[t]("change",R),k[t]("change",W),C[t]("change",Y),b[t]("change",A),T[t]("change",G),L[t]("submit",O)},K=e=>{e.preventDefault(),L.reset(),Oe()},Q=document.querySelector(".map__pin--main"),Z=()=>Q.offsetHeight,ee=e=>{(function(e){return 0===e.button})(e)&&(Be(),((e,t,o)=>{let r={x:e.clientX,y:e.clientY};const n=e=>{const o=r.x-e.clientX,n=r.y-e.clientY;r={x:e.clientX,y:e.clientY};const s=()=>t.offsetHeight+22,c=()=>130-s(),a=()=>630-s();t.offsetTop<c()?t.style.top=c()+"px":t.offsetTop>a()?t.style.top=a()+"px":t.style.top=t.offsetTop-n+"px";const u=()=>Math.ceil(t.offsetWidth/2),l=()=>1200-u();t.offsetLeft<0-u()?t.style.left=-u()+"px":t.offsetLeft>l()?t.style.left=l()+"px":t.style.left=t.offsetLeft-o+"px",Oe()},s=()=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",s)})(e,Q))},te=e=>{m(e)&&Be()};(e=>{const t="addEventListener";Q[t]("mousedown",ee),Q[t]("keydown",te)})();const oe={flat:"Квартира",bungalow:"Бунгало",palace:"Дворец",house:"Дом"},re=document.querySelector(".map__filters-container"),ne=document.querySelector("#card").content.querySelector(".map__card");let se=null;const ce=(e,t,o)=>e?o(t):t.remove(),ae=e=>{const t=document.createElement("li");return t.classList.add("popup__feature","popup__feature--"+e),t},ue=e=>{const t=document.createElement("img");return t.classList.add("popup__photo"),t.style.width="45px",t.style.height="40px",t.src=""+e,t},le=e=>{f(e)&&(pe(!1,se),de())},ie=()=>{pe(!1,se),de()},de=()=>{se&&se.remove()},pe=(e,t)=>{const o=e?"addEventListener":"removeEventListener",r=t.querySelector(".popup__close");r&&(r[o]("click",ie),document[o]("keydown",le))},me=e=>{de(),se=(e=>{const t=(e=>{const t=ne.cloneNode(!0);return ce(e.offer.title,t.querySelector(".popup__title"),(t=>{t.textContent=e.offer.title})),ce(e.offer.address,t.querySelector(".popup__text--address"),(t=>{t.textContent=e.offer.address})),ce(e.offer.price,t.querySelector(".popup__text--price"),(t=>{t.textContent=e.offer.price+"₽/ночь"})),ce(e.offer.type,t.querySelector(".popup__type"),(t=>{t.textContent=oe[e.offer.type]})),ce(e.offer.rooms&&e.offer.guests,t.querySelector(".popup__text--capacity"),(t=>{t.textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`})),ce(e.offer.checkin&&e.offer.checkout,t.querySelector(".popup__text--time"),(t=>{t.textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`})),ce(e.offer.description,t.querySelector(".popup__description"),(t=>{t.textContent=e.offer.description})),ce(e.author.avatar,t.querySelector(".popup__avatar"),(t=>{t.src=e.author.avatar})),h(e.offer.photos,t.querySelector(".popup__photos"),ue),h(e.offer.features,t.querySelector(".popup__features"),ae),t})(e);return ze(t,re),pe(!0,t),t})(e)},fe=50,ye=70,he="map__pin--secondary",ve="map__pin--active",ge=5,_e=document.querySelector(".map__pins"),Se=document.querySelector("#pin").content.querySelector(".map__pin");let qe=null,Le=null,Ee=null,xe=null;const ke=(e,t)=>{const o=Se.cloneNode(!0);o.classList.add(he),((e,t)=>{e.style.top=t.y-ye+"px",e.style.left=t.x-fe/2+"px"})(o,e.location);const r=o.querySelector("img");return r.src=""+e.author.avatar,r.alt=""+e.offer.title,o.value=t,o.addEventListener("click",we),o.addEventListener("keydown",be),o},Ce=()=>{null!==qe&&qe!==[]&&qe.forEach((e=>e.remove()))},we=e=>{xe&&xe.classList.remove(ve);const t=e.currentTarget;xe=t,t.classList.add(ve),me(Ee?Ee[t.value]:Le[t.value])},be=e=>{m(e)&&we(e)},Te=e=>{Ce(),de(),Ee=e(Le,ge),qe=y(Ee,_e,ke)},$e=document.querySelector(".map__filters"),Ve=$e.querySelector("#housing-type"),je=$e.querySelector("#housing-price"),De=$e.querySelector("#housing-rooms"),Me=$e.querySelector("#housing-guests"),Ne=$e.querySelector("#housing-features"),Fe=new Set,Ie={"housing-type":"any","housing-price":"any","housing-rooms":"any","housing-guests":"any"},Xe=function(e){return"any"===e},He=(e,t)=>((e,t,o)=>{const r=[];for(let n=0;n<e.length&&r.length!==o;n++){const o=e[n];t(o)&&r.push(o)}return r})(e,(e=>{return o=e.offer.type,r=Ie["housing-type"],(Xe(r)||o===r)&&((e,t)=>Xe(t)||"low"===t&&e<1e4||"middle"===t&&e>=1e4&&e<=5e4||"high"===t&&e>5e4)(e.offer.price,Ie["housing-price"])&&((e,t)=>Xe(t)||e===+t)(e.offer.rooms,Ie["housing-rooms"])&&((e,t)=>Xe(t)||e===+t)(e.offer.guests,Ie["housing-guests"])&&(t=e.offer.features,[...Fe].every((e=>t.includes(e.value))));var t,o,r}),t),Re=p((e=>{Ie[e.target.name]=e.target.value,Te(He)})),We=p((e=>{Fe.has(e.target)?Fe.delete(e.target):Fe.add(e.target),Te(He)})),Ye=e=>{const t=e?"addEventListener":"removeEventListener";Ve[t]("change",Re),je[t]("change",Re),De[t]("change",Re),Me[t]("change",Re),Ne[t]("change",We)},Ae=document.querySelector(".map"),Ge=()=>{Ae.classList.add("map--faded"),Ce(),de(),L.classList.add("ad-form--disabled"),X(L.children,!0),X($.children,!0),J(!1),V.removeEventListener("click",K),_(M,N,!1),_(F,I,!1),Oe(),Ye(!1),Object.assign(Ie,{"housing-type":"any","housing-price":"any","housing-rooms":"any","housing-guests":"any"}),Fe.clear(),$e.reset()},Oe=()=>{return e=Math.round(parseInt(Q.style.left,10)+Q.offsetWidth/2),t=Ae.classList.contains("map--faded")?Math.round(parseInt(Q.style.top,10)+Z()/2):Math.round(parseInt(Q.style.top,10)+Z()+22),void(E.value=`${e}, ${t}`);var e,t},Be=()=>{Ae.classList.contains("map--faded")&&(((e,t)=>{d(u,e,t)})(Pe,Ue),Oe())},Pe=e=>{(e=>{Ae.classList.remove("map--faded"),Le=e,Ce(),qe=y(Le,_e,ke,ge),L.classList.remove("ad-form--disabled"),X(L.children,!1),X($.children,!1),J(!0),V.addEventListener("click",K),_(M,N,!0),_(F,I,!0),Ye(!0)})(e)},Ue=e=>{const t=document.createElement("div");t.classList.add("error_popup"),t.textContent=e,document.body.appendChild(t)};Oe();const ze=(e,t)=>{Ae.insertBefore(e,t)}})();