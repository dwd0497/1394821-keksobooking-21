(()=>{"use strict";const e="100 комнат не для гостей",t="Не для гостей только 100 комнатные номера",o="Количество мест не может превышать количество комнат",r="Произошла ошибка соединения.",n="Запрос не успел выполниться за",s="мс",c="GET",a="POST",u="https://21.javascript.pages.academy/keksobooking/data",l="https://21.javascript.pages.academy/keksobooking",i={400:"Неверный запрос. Ошибка 400.",401:"Пользователь не авторизован. Ошибка 401.",404:"Информация не найдена. Ошибка 404.",500:"Ошибка сервера. Ошибка 500."},d=(e,t,o,a=c,u=null)=>{const l=new XMLHttpRequest;l.responseType="json",l.addEventListener("load",(()=>{200===l.status?t(l.response):o(i[l.status])})),l.addEventListener("error",(function(){o(r)})),l.addEventListener("timeout",(function(){o(`${n} ${l.timeout} ${s}`)})),l.timeout=1e4,l.open(a,e),l.send(u)},p=e=>{let t=null;return(...o)=>{t&&clearTimeout(t),t=setTimeout((()=>{e(...o)}),500)}};function m(e){return"Enter"===e.key}function f(e){return"Escape"===e.key}const y=(e,t,o,r=null)=>{const n=document.createDocumentFragment();let s=[];return r&&(e=e.slice(0,r)),e.forEach(((e,t)=>{const r=o(e,t);n.appendChild(r),s.push(r)})),t.appendChild(n),s},h=(e,t,o)=>{v(t),((e,t,o)=>{const r=document.createDocumentFragment();e.forEach(((e,t)=>{r.appendChild(o(e,t))})),t.appendChild(r)})(e,t,o)},v=e=>{for(;e.firstChild;)e.firstChild.remove()},g=(e,t)=>Array.prototype.forEach.call(e,t),_=["gif","jpg","jpeg","png"],S=e=>{"IMG"!==e.tagName?v(e):e.src="img/muffin-grey.svg"},q=(e,t,o)=>{e[o?"addEventListener":"removeEventListener"]("change",(()=>{const o=document.createDocumentFragment();let r=0;g(e.files,(n=>{const s=n.name.toLowerCase();if(_.some((e=>s.endsWith(e)))){const s=new FileReader;s.addEventListener("load",(()=>{if("IMG"!==t.tagName){const n=document.createElement("img");n.src=s.result,o.appendChild(n),r++,r===e.files.length&&t.appendChild(o)}else t.src=s.result})),s.readAsDataURL(n)}}))}))},L={bungalow:0,flat:1e3,house:5e3,palace:1e4},E=document.querySelector("main"),k=document.querySelector(".ad-form"),x=k.querySelector("#address"),C=k.querySelector("#capacity"),w=k.querySelector("#room_number"),b=k.querySelector("#type"),T=k.querySelector("#price"),$=k.querySelector("#timein"),D=k.querySelector("#timeout"),M=document.querySelector(".map__filters"),V=document.querySelector(".ad-form__reset"),j=document.querySelector("#success").content.querySelector(".success"),N=document.querySelector("#error").content.querySelector(".error"),F=document.querySelector("#avatar"),I=document.querySelector(".ad-form-header__preview img"),X=document.querySelector("#images"),G=document.querySelector(".ad-form__photo"),H=(e,t)=>{g(e,(function(e){e.disabled=t}))};H(k.children,!0),H(M.children,!0);const R=(r,n,s)=>{100===r&&0!==n?s.setCustomValidity(e):r<n&&0!==n?s.setCustomValidity(o):100!==r&&0===n?s.setCustomValidity(t):s.setCustomValidity(""),s.reportValidity()},W=()=>{const e=+C.value,t=+w.value;R(t,e,C)},Y=()=>{const e=+C.value,t=+w.value;R(t,e,C)},A=()=>{T.min=L[b.value],T.placeholder=L[b.value]},O=()=>{D.value=$.value},B=()=>{$.value=D.value},P=e=>{e.preventDefault();const t=+C.value,o=+w.value;R(o,t,C),C.checkValidity()&&w.checkValidity()&&((e,t,o)=>{d(l,e,t,a,o)})(J,K,new FormData(k))},U=e=>()=>{e.remove()},z=e=>t=>{f(t)&&(document.removeEventListener("keydown",z(e)),e.remove())},J=()=>{(()=>{const e=j.cloneNode(!0);k.appendChild(e),e.addEventListener("click",U(e)),document.addEventListener("keydown",z(e))})(),Be(),k.reset(),Pe()},K=e=>{(e=>{const t=N.cloneNode(!0),o=t.querySelector(".error__message"),r=t.querySelector(".error__button");o.textContent=e,E.appendChild(t),t.addEventListener("click",U(t)),r.addEventListener("click",(e=>()=>{e.remove()})(t)),document.addEventListener("keydown",z(t))})(e)},Q=e=>{const t=e?"addEventListener":"removeEventListener";C[t]("change",W),w[t]("change",Y),b[t]("change",A),$[t]("change",O),D[t]("change",B),k[t]("submit",P)},Z=e=>{e.preventDefault(),k.reset(),Pe()},ee=document.querySelector(".map__pin--main"),te=()=>ee.offsetHeight,oe=e=>{(function(e){return 0===e.button})(e)&&(Ue(),((e,t,o)=>{let r={x:e.clientX,y:e.clientY};const n=e=>{const o=r.x-e.clientX,n=r.y-e.clientY;r={x:e.clientX,y:e.clientY};const s=()=>t.offsetHeight+22,c=()=>130-s(),a=()=>630-s();t.offsetTop<c()?t.style.top=c()+"px":t.offsetTop>a()?t.style.top=a()+"px":t.style.top=t.offsetTop-n+"px";const u=()=>Math.ceil(t.offsetWidth/2),l=()=>1200-u();t.offsetLeft<0-u()?t.style.left=-u()+"px":t.offsetLeft>l()?t.style.left=l()+"px":t.style.left=t.offsetLeft-o+"px",Pe()},s=()=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",s)})(e,ee))},re=e=>{m(e)&&Ue()};(e=>{const t="addEventListener";ee[t]("mousedown",oe),ee[t]("keydown",re)})();const ne=document.querySelector(".map__filters-container"),se=document.querySelector("#card").content.querySelector(".map__card"),ce={flat:"Квартира",bungalow:"Бунгало",palace:"Дворец",house:"Дом"};let ae=null;const ue=(e,t,o)=>e?o(t):t.remove(),le=e=>{const t=document.createElement("li");return t.classList.add("popup__feature","popup__feature--"+e),t},ie=e=>{const t=document.createElement("img");return t.classList.add("popup__photo"),t.style.width="45px",t.style.height="40px",t.src=""+e,t},de=e=>{f(e)&&(fe(!1,ae),me())},pe=()=>{fe(!1,ae),me()},me=()=>{ae&&ae.remove()},fe=(e,t)=>{const o=e?"addEventListener":"removeEventListener",r=t.querySelector(".popup__close");r&&(r[o]("click",pe),document[o]("keydown",de))},ye=e=>{me(),ae=(e=>{const t=(e=>{const t=se.cloneNode(!0);return ue(e.offer.title,t.querySelector(".popup__title"),(t=>{t.textContent=e.offer.title})),ue(e.offer.address,t.querySelector(".popup__text--address"),(t=>{t.textContent=e.offer.address})),ue(e.offer.price,t.querySelector(".popup__text--price"),(t=>{t.textContent=e.offer.price+"₽/ночь"})),ue(e.offer.type,t.querySelector(".popup__type"),(t=>{t.textContent=ce[e.offer.type]})),ue(e.offer.rooms&&e.offer.guests,t.querySelector(".popup__text--capacity"),(t=>{t.textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`})),ue(e.offer.checkin&&e.offer.checkout,t.querySelector(".popup__text--time"),(t=>{t.textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`})),ue(e.offer.description,t.querySelector(".popup__description"),(t=>{t.textContent=e.offer.description})),ue(e.author.avatar,t.querySelector(".popup__avatar"),(t=>{t.src=e.author.avatar})),h(e.offer.photos,t.querySelector(".popup__photos"),ie),h(e.offer.features,t.querySelector(".popup__features"),le),t})(e);return Ke(t,ne),fe(!0,t),t})(e)},he=50,ve=70,ge="map__pin--secondary",_e="map__pin--active",Se=5,qe=document.querySelector(".map__pins"),Le=document.querySelector("#pin").content.querySelector(".map__pin");let Ee=null,ke=null,xe=null,Ce=null;const we=(e,t)=>{const o=Le.cloneNode(!0);o.classList.add(ge),((e,t)=>{e.style.top=t.y-ve+"px",e.style.left=t.x-he/2+"px"})(o,e.location);const r=o.querySelector("img");return r.src=""+e.author.avatar,r.alt=""+e.offer.title,o.value=t,o.addEventListener("click",Te),o.addEventListener("keydown",$e),o},be=()=>{null!==Ee&&Ee!==[]&&Ee.forEach((e=>e.remove()))},Te=e=>{Ce&&Ce.classList.remove(_e);const t=e.currentTarget;Ce=t,t.classList.add(_e),ye(xe?xe[t.value]:ke[t.value])},$e=e=>{m(e)&&Te(e)},De=e=>{be(),me(),xe=e(ke,Se),Ee=y(xe,qe,we)},Me=document.querySelector(".map__filters"),Ve=Me.querySelector("#housing-type"),je=Me.querySelector("#housing-price"),Ne=Me.querySelector("#housing-rooms"),Fe=Me.querySelector("#housing-guests"),Ie=Me.querySelector("#housing-features"),Xe=new Set,Ge={"housing-type":"any","housing-price":"any","housing-rooms":"any","housing-guests":"any"},He=function(e){return"any"===e},Re=(e,t)=>((e,t,o)=>{const r=[];for(let n=0;n<e.length&&r.length!==o;n++){const o=e[n];t(o)&&r.push(o)}return r})(e,(e=>{return o=e.offer.type,r=Ge["housing-type"],(He(r)||o===r)&&((e,t)=>He(t)||"low"===t&&e<1e4||"middle"===t&&e>=1e4&&e<=5e4||"high"===t&&e>5e4)(e.offer.price,Ge["housing-price"])&&((e,t)=>He(t)||e===+t)(e.offer.rooms,Ge["housing-rooms"])&&((e,t)=>He(t)||e===+t)(e.offer.guests,Ge["housing-guests"])&&(t=e.offer.features,[...Xe].every((e=>t.includes(e.value))));var t,o,r}),t),We=p((e=>{Ge[e.target.name]=e.target.value,De(Re)})),Ye=p((e=>{Xe.has(e.target)?Xe.delete(e.target):Xe.add(e.target),De(Re)})),Ae=e=>{const t=e?"addEventListener":"removeEventListener";Ve[t]("change",We),je[t]("change",We),Ne[t]("change",We),Fe[t]("change",We),Ie[t]("change",Ye)},Oe=document.querySelector(".map"),Be=()=>{Oe.classList.add("map--faded"),be(),me(),k.classList.add("ad-form--disabled"),H(k.children,!0),H(M.children,!0),Q(!1),V.removeEventListener("click",Z),q(F,I,!1),q(X,G,!1),S(I),S(G),Ae(!1),Object.assign(Ge,{"housing-type":"any","housing-price":"any","housing-rooms":"any","housing-guests":"any"}),Xe.clear(),Me.reset()},Pe=()=>{return e=Math.round(parseInt(ee.style.left,10)+ee.offsetWidth/2),t=Oe.classList.contains("map--faded")?Math.round(parseInt(ee.style.top,10)+te()/2):Math.round(parseInt(ee.style.top,10)+te()+22),void(x.value=`${e}, ${t}`);var e,t},Ue=()=>{Oe.classList.contains("map--faded")&&(((e,t)=>{d(u,e,t)})(ze,Je),Pe())},ze=e=>{(e=>{Oe.classList.remove("map--faded"),ke=e,be(),Ee=y(ke,qe,we,Se),k.classList.remove("ad-form--disabled"),H(k.children,!1),H(M.children,!1),Q(!0),V.addEventListener("click",Z),q(F,I,!0),q(X,G,!0),Ae(!0)})(e)},Je=e=>{const t=document.createElement("div");t.classList.add("error_popup"),t.textContent=e;const o=e=>{f(e)&&(t.remove(),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o),document.body.appendChild(t)};Pe();const Ke=(e,t)=>{Oe.insertBefore(e,t)}})();