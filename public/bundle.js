(()=>{"use strict";const e="100 комнат не для гостей",t="Не для гостей только 100 комнатные номера",o="Количество мест не может превышать количество комнат",r="Произошла ошибка соединения.",n="Запрос не успел выполниться за",s="мс",c="GET",a="POST",u="https://21.javascript.pages.academy/keksobooking/data",l="https://21.javascript.pages.academy/keksobooking",i={400:"Неверный запрос. Ошибка 400.",401:"Пользователь не авторизован. Ошибка 401.",404:"Информация не найдена. Ошибка 404.",500:"Ошибка сервера. Ошибка 500."},d=(e,t,o,a=c,u=null)=>{const l=new XMLHttpRequest;l.responseType="json",l.addEventListener("load",(()=>{200===l.status?t(l.response):o(i[l.status])})),l.addEventListener("error",(function(){o(r)})),l.addEventListener("timeout",(function(){o(`${n} ${l.timeout} ${s}`)})),l.timeout=1e4,l.open(a,e),l.send(u)},p=e=>{let t=null;return(...o)=>{t&&clearTimeout(t),t=setTimeout((()=>{e(...o)}),500)}};function m(e){return"Enter"===e.key}function f(e){return"Escape"===e.key}const y=(e,t,o,r=null)=>{const n=document.createDocumentFragment();let s=[];return r&&(e=e.slice(0,r)),e.forEach(((e,t)=>{const r=o(e,t);n.appendChild(r),s.push(r)})),t.appendChild(n),s},h=(e,t,o)=>{v(t),((e,t,o)=>{const r=document.createDocumentFragment();e.forEach(((e,t)=>{r.appendChild(o(e,t))})),t.appendChild(r)})(e,t,o)},v=e=>{for(;e.firstChild;)e.firstChild.remove()},g=(e,t)=>Array.prototype.forEach.call(e,t),_=["gif","jpg","jpeg","png"],S=(e,t,o)=>{e[o?"addEventListener":"removeEventListener"]("change",(()=>{g(e.files,(e=>{const o=e.name.toLowerCase();if(_.some((e=>o.endsWith(e)))){const o=new FileReader;o.addEventListener("load",(()=>{"IMG"!==t.tagName?(e=>{const t=document.createElement("img");return e.appendChild(t),t})(t).src=o.result:t.src=o.result})),o.readAsDataURL(e)}}))}))},q={bungalow:0,flat:1e3,house:5e3,palace:1e4},L=document.querySelector("main"),E=document.querySelector(".ad-form"),k=E.querySelector("#address"),x=E.querySelector("#capacity"),C=E.querySelector("#room_number"),w=E.querySelector("#type"),b=E.querySelector("#price"),T=E.querySelector("#timein"),$=E.querySelector("#timeout"),V=document.querySelector(".map__filters"),j=document.querySelector(".ad-form__reset"),D=document.querySelector("#success").content.querySelector(".success"),M=document.querySelector("#error").content.querySelector(".error"),N=document.querySelector("#avatar"),F=document.querySelector(".ad-form-header__preview img"),I=document.querySelector("#images"),X=document.querySelector(".ad-form__photo"),H=(e,t)=>{g(e,(function(e){e.disabled=t}))};H(E.children,!0),H(V.children,!0);const R=(r,n,s)=>{100===r&&0!==n?s.setCustomValidity(e):r<n&&0!==n?s.setCustomValidity(o):100!==r&&0===n?s.setCustomValidity(t):s.setCustomValidity(""),s.reportValidity()},W=()=>{const e=+x.value,t=+C.value;R(t,e,x)},Y=()=>{const e=+x.value,t=+C.value;R(t,e,x)},A=()=>{b.min=q[w.value],b.placeholder=q[w.value]},G=()=>{$.value=T.value},O=()=>{T.value=$.value},B=e=>{e.preventDefault();const t=+x.value,o=+C.value;R(o,t,x),x.checkValidity()&&C.checkValidity()&&((e,t,o)=>{d(l,e,t,a,o)})(z,J,new FormData(E))},P=e=>()=>{e.remove()},U=e=>t=>{f(t)&&(document.removeEventListener("keydown",U(e)),e.remove())},z=()=>{(()=>{const e=D.cloneNode(!0);E.appendChild(e),e.addEventListener("click",P(e)),document.addEventListener("keydown",U(e))})(),Oe(),E.reset()},J=e=>{(e=>{const t=M.cloneNode(!0),o=t.querySelector(".error__message"),r=t.querySelector(".error__button");o.textContent=e,L.appendChild(t),t.addEventListener("click",P(t)),r.addEventListener("click",(e=>()=>{e.remove()})(t)),document.addEventListener("keydown",U(t))})(e)},K=e=>{const t=e?"addEventListener":"removeEventListener";x[t]("change",W),C[t]("change",Y),w[t]("change",A),T[t]("change",G),$[t]("change",O),E[t]("submit",B)},Q=e=>{e.preventDefault(),E.reset(),Be()},Z=document.querySelector(".map__pin--main"),ee=()=>Z.offsetHeight,te=e=>{(function(e){return 0===e.button})(e)&&(Pe(),((e,t,o)=>{let r={x:e.clientX,y:e.clientY};const n=e=>{const o=r.x-e.clientX,n=r.y-e.clientY;r={x:e.clientX,y:e.clientY};const s=()=>t.offsetHeight+22,c=()=>130-s(),a=()=>630-s();t.offsetTop<c()?t.style.top=c()+"px":t.offsetTop>a()?t.style.top=a()+"px":t.style.top=t.offsetTop-n+"px";const u=()=>Math.ceil(t.offsetWidth/2),l=()=>1200-u();t.offsetLeft<0-u()?t.style.left=-u()+"px":t.offsetLeft>l()?t.style.left=l()+"px":t.style.left=t.offsetLeft-o+"px",Be()},s=()=>{document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",s)})(e,Z))},oe=e=>{m(e)&&Pe()};(e=>{const t="addEventListener";Z[t]("mousedown",te),Z[t]("keydown",oe)})();const re={flat:"Квартира",bungalow:"Бунгало",palace:"Дворец",house:"Дом"},ne=document.querySelector(".map__filters-container"),se=document.querySelector("#card").content.querySelector(".map__card");let ce=null;const ae=(e,t,o)=>e?o(t):t.remove(),ue=e=>{const t=document.createElement("li");return t.classList.add("popup__feature","popup__feature--"+e),t},le=e=>{const t=document.createElement("img");return t.classList.add("popup__photo"),t.style.width="45px",t.style.height="40px",t.src=""+e,t},ie=e=>{f(e)&&(me(!1,ce),pe())},de=()=>{me(!1,ce),pe()},pe=()=>{ce&&ce.remove()},me=(e,t)=>{const o=e?"addEventListener":"removeEventListener",r=t.querySelector(".popup__close");r&&(r[o]("click",de),document[o]("keydown",ie))},fe=e=>{pe(),ce=(e=>{const t=(e=>{const t=se.cloneNode(!0);return ae(e.offer.title,t.querySelector(".popup__title"),(t=>{t.textContent=e.offer.title})),ae(e.offer.address,t.querySelector(".popup__text--address"),(t=>{t.textContent=e.offer.address})),ae(e.offer.price,t.querySelector(".popup__text--price"),(t=>{t.textContent=e.offer.price+"₽/ночь"})),ae(e.offer.type,t.querySelector(".popup__type"),(t=>{t.textContent=re[e.offer.type]})),ae(e.offer.rooms&&e.offer.guests,t.querySelector(".popup__text--capacity"),(t=>{t.textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`})),ae(e.offer.checkin&&e.offer.checkout,t.querySelector(".popup__text--time"),(t=>{t.textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`})),ae(e.offer.description,t.querySelector(".popup__description"),(t=>{t.textContent=e.offer.description})),ae(e.author.avatar,t.querySelector(".popup__avatar"),(t=>{t.src=e.author.avatar})),h(e.offer.photos,t.querySelector(".popup__photos"),le),h(e.offer.features,t.querySelector(".popup__features"),ue),t})(e);return Je(t,ne),me(!0,t),t})(e)},ye=50,he=70,ve="map__pin--secondary",ge="map__pin--active",_e=5,Se=document.querySelector(".map__pins"),qe=document.querySelector("#pin").content.querySelector(".map__pin");let Le=null,Ee=null,ke=null,xe=null;const Ce=(e,t)=>{const o=qe.cloneNode(!0);o.classList.add(ve),((e,t)=>{e.style.top=t.y-he+"px",e.style.left=t.x-ye/2+"px"})(o,e.location);const r=o.querySelector("img");return r.src=""+e.author.avatar,r.alt=""+e.offer.title,o.value=t,o.addEventListener("click",be),o.addEventListener("keydown",Te),o},we=()=>{null!==Le&&Le!==[]&&Le.forEach((e=>e.remove()))},be=e=>{xe&&xe.classList.remove(ge);const t=e.currentTarget;xe=t,t.classList.add(ge),fe(ke?ke[t.value]:Ee[t.value])},Te=e=>{m(e)&&be(e)},$e=e=>{we(),pe(),ke=e(Ee,_e),Le=y(ke,Se,Ce)},Ve=document.querySelector(".map__filters"),je=Ve.querySelector("#housing-type"),De=Ve.querySelector("#housing-price"),Me=Ve.querySelector("#housing-rooms"),Ne=Ve.querySelector("#housing-guests"),Fe=Ve.querySelector("#housing-features"),Ie=new Set,Xe={"housing-type":"any","housing-price":"any","housing-rooms":"any","housing-guests":"any"},He=function(e){return"any"===e},Re=(e,t)=>((e,t,o)=>{const r=[];for(let n=0;n<e.length&&r.length!==o;n++){const o=e[n];t(o)&&r.push(o)}return r})(e,(e=>{return o=e.offer.type,r=Xe["housing-type"],(He(r)||o===r)&&((e,t)=>He(t)||"low"===t&&e<1e4||"middle"===t&&e>=1e4&&e<=5e4||"high"===t&&e>5e4)(e.offer.price,Xe["housing-price"])&&((e,t)=>He(t)||e===+t)(e.offer.rooms,Xe["housing-rooms"])&&((e,t)=>He(t)||e===+t)(e.offer.guests,Xe["housing-guests"])&&(t=e.offer.features,[...Ie].every((e=>t.includes(e.value))));var t,o,r}),t),We=p((e=>{Xe[e.target.name]=e.target.value,$e(Re)})),Ye=p((e=>{Ie.has(e.target)?Ie.delete(e.target):Ie.add(e.target),$e(Re)})),Ae=e=>{const t=e?"addEventListener":"removeEventListener";je[t]("change",We),De[t]("change",We),Me[t]("change",We),Ne[t]("change",We),Fe[t]("change",Ye)},Ge=document.querySelector(".map"),Oe=()=>{Ge.classList.add("map--faded"),we(),pe(),E.classList.add("ad-form--disabled"),H(E.children,!0),H(V.children,!0),K(!1),j.removeEventListener("click",Q),S(N,F,!1),S(I,X,!1),Be(),Ae(!1),Object.assign(Xe,{"housing-type":"any","housing-price":"any","housing-rooms":"any","housing-guests":"any"}),Ie.clear(),Ve.reset()},Be=()=>{return e=Math.round(parseInt(Z.style.left,10)+Z.offsetWidth/2),t=Ge.classList.contains("map--faded")?Math.round(parseInt(Z.style.top,10)+ee()/2):Math.round(parseInt(Z.style.top,10)+ee()+22),void(k.value=`${e}, ${t}`);var e,t},Pe=()=>{Ge.classList.contains("map--faded")&&(((e,t)=>{d(u,e,t)})(Ue,ze),Be())},Ue=e=>{(e=>{Ge.classList.remove("map--faded"),Ee=e,we(),Le=y(Ee,Se,Ce,_e),E.classList.remove("ad-form--disabled"),H(E.children,!1),H(V.children,!1),K(!0),j.addEventListener("click",Q),S(N,F,!0),S(I,X,!0),Ae(!0)})(e)},ze=e=>{const t=document.createElement("div");t.classList.add("error_popup"),t.textContent=e,document.body.appendChild(t)};Be();const Je=(e,t)=>{Ge.insertBefore(e,t)}})();